<!DOCTYPE html>
<html>

<head>
    <title>Connexion Discord</title>
    <link rel="icon"
        href="https://cdn.discordapp.com/avatars/665299853106085888/b300d8ca271e9ee8b2551cac3355ca53.png?size=128">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"
        integrity="sha256-/H4YS+7aYb9kJ5OKhFYPUjSJdrtV6AeyJOtTkw6X72o=" crossorigin="anonymous"></script>
</head>

<body>
    <p id='test'>chargement en cours, vous allez être redirigé...</p>
    <p id="lien"></p>
    <script>
        async function encryptText(text, keyString) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);

            // Hardcoded encryption key as a string
            const keyBuffer = new TextEncoder().encode(keyString);
            const key = await window.crypto.subtle.importKey(
                'raw', keyBuffer, 'AES-CBC', false, ['encrypt']
            );

            const iv = window.crypto.getRandomValues(new Uint8Array(16));
            const encryptedData = await window.crypto.subtle.encrypt(
                { name: 'AES-CBC', iv: iv },
                key,
                data
            );

            return { iv: iv, encryptedData: encryptedData };
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        const params = new URLSearchParams(window.location.search);
        const c = params.get("code");
        const s = params.get("state");
        encryptText(c, s)
            .then(result => {
                let encrypted = arrayBufferToBase64(result.encryptedData);
                let iv = arrayBufferToBase64(result.iv);
                console.log('Encrypted:', arrayBufferToBase64(result.encryptedData));
                console.log('Iv:', arrayBufferToBase64(result.iv))
                let lien = "http://80.119.177.18:5000/?code=" + encrypted + "&iv=" + iv;
                window.location = lien;
                document.getElementById("lien").innerHTML = `si ça ne fonctionne pas, cliquez sur <a href="${lien}">ce lien</a>`
            })
            .catch(error => {
                console.error('Encryption error:', error);
            });
    </script>
</body>

</html>
