<!DOCTYPE html>
<html>

<head>
    <title>Connexion Discord</title>
    <link rel="icon"
        href="https://cdn.discordapp.com/avatars/665299853106085888/b300d8ca271e9ee8b2551cac3355ca53.png?size=128">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"
        integrity="sha256-/H4YS+7aYb9kJ5OKhFYPUjSJdrtV6AeyJOtTkw6X72o=" crossorigin="anonymous"></script>
</head>

<body>
    <p id='test'>chargement en cours, vous allez être redirigé...</p>
    <p id="lien"></p>
    <script>
        async function encryptText(text, key) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const cryptoKey = await window.crypto.subtle.importKey(
                'raw', new TextEncoder().encode(key), 'AES-CBC', false, ['encrypt']
            );

            const iv = window.crypto.getRandomValues(new Uint8Array(16));
            const encryptedData = await window.crypto.subtle.encrypt(
                { name: 'AES-CBC', iv: iv },
                cryptoKey,
                data
            );

            return { iv: iv, encryptedData: encryptedData };
        }

        const parsedHash = new URLSearchParams(
            window.location.hash.substring(1) // any_hash_key=any_value
        );
        const c = parsedHash.get("access_token");
        const s = parsedHash.get("state");
        console.log('at:', c);
        console.log('s:', s);
        encryptText(c, s)
            .then(result => {
                const iv = window.btoa(String.fromCharCode(...result.iv));
                const encrypted = window.btoa(String.fromCharCode(...new Uint8Array(result.encryptedData)));

                console.log('IV (Base64):', iv);
                console.log('Encrypted Data (Base64):', encrypted);
                //let lien = "http://80.119.177.18:5000/api/key/?code=" + encrypted + "&iv=" + iv;
                //window.location = lien;
                document.getElementById("lien").innerHTML = `si ça ne fonctionne pas, cliquez sur <a href="${lien}">ce lien</a>`
            })
            .catch(error => {
                console.error('Encryption error:', error);
            });
    </script>
</body>

</html>
